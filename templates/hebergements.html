{% extends "base.html" %}
{% block title %}H√©bergements{% endblock %}

{% block content %}
{% set q = request.args.get('q','') %}
{% set statut = request.args.get('statut','') %}
{% set type_id = request.args.get('type_id','') %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-0"><i class="bi bi-house-door"></i> H√©bergements</h2>
    <div class="text-muted">
      {{ hebergements.total }} r√©sultat(s)
      {% if q or statut or type_id %}
        ‚Ä¢ filtres actifs
      {% endif %}
    </div>
  </div>

  {% if current_user.role == 'admin' %}
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
    <i class="bi bi-plus-circle"></i> Ajouter
  </button>
  {% endif %}
</div>

<!-- Filtres (serveur, compatibles pagination) -->
<form method="GET" action="{{ url_for('hebergements') }}" class="row g-2 mb-4">
  <div class="col-md-6">
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input
        type="text"
        name="q"
        class="form-control form-control-lg"
        placeholder="Rechercher (ex: 12, STAFF, Bien-√ätre, Cabane...)"
        value="{{ q }}"
        id="qInput"
      >
    </div>
  </div>

  <div class="col-md-3">
    <select class="form-select form-select-lg" name="statut" id="statutSelect">
      <option value="">Tous les statuts</option>
      <option value="ok" {{ 'selected' if statut=='ok' else '' }}>OK</option>
      <option value="alerte" {{ 'selected' if statut=='alerte' else '' }}>Alerte</option>
      <option value="probleme" {{ 'selected' if statut=='probleme' else '' }}>Probl√®me</option>
    </select>
  </div>

  <div class="col-md-3">
    <select class="form-select form-select-lg" name="type_id" id="typeSelect">
      <option value="">Tous les types</option>
      {% for t in types %}
      <option value="{{ t.id }}" {{ 'selected' if type_id == (t.id|string) else '' }}>
        {{ t.nom }}
      </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-12 d-flex gap-2">
    <button class="btn btn-primary" type="submit">
      <i class="bi bi-funnel"></i> Filtrer
    </button>
    <a class="btn btn-outline-secondary" href="{{ url_for('hebergements') }}">
      R√©initialiser
    </a>

    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-danger" href="{{ url_for('hebergements', statut='probleme', q=q, type_id=type_id) }}">
        <i class="bi bi-exclamation-octagon"></i> Probl√®mes
      </a>
      <a class="btn btn-outline-warning" href="{{ url_for('hebergements', statut='alerte', q=q, type_id=type_id) }}">
        <i class="bi bi-exclamation-triangle"></i> Alertes
      </a>
      <a class="btn btn-outline-success" href="{{ url_for('hebergements', statut='ok', q=q, type_id=type_id) }}">
        <i class="bi bi-check2-circle"></i> OK
      </a>
    </div>
  </div>
</form>

{% if hebergements.total == 0 %}
<div class="text-center mt-5">
  <i class="bi bi-search" style="font-size: 4rem; color: #ccc;"></i>
  <h4 class="mt-3 text-muted">Aucun h√©bergement trouv√©</h4>
  <p class="text-muted">Essaie un autre terme ou enl√®ve des filtres.</p>
</div>
{% else %}

<!-- Liste des h√©bergements -->
<div class="row">
  {% for heb, check_count, last_check_at, incident_count in hebergements.items %}
  {% set check_count = check_count or 0 %}
  {% set incident_count = incident_count or 0 %}

  <div class="col-md-4 mb-3">
    <div class="card h-100 shadow-sm
      {% if heb.statut == 'probleme' %}border-danger
      {% elif heb.statut == 'alerte' %}border-warning
      {% else %}border-success{% endif %}">
      <div class="card-body d-flex flex-column">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="card-title mb-0">{{ heb.emplacement }}</h5>

          {% if heb.statut == 'ok' %}
          <span class="badge bg-success">OK</span>
          {% elif heb.statut == 'alerte' %}
          <span class="badge bg-warning text-dark">Alerte</span>
          {% else %}
          <span class="badge bg-danger">Probl√®me</span>
          {% endif %}
        </div>

        <div class="text-muted small mb-2">
          <div><strong>Type :</strong> {{ heb.type_hebergement.nom }}</div>
          <div><strong>N¬∞ Ch√¢ssis :</strong> {{ heb.numero_chassis or 'N/A' }}</div>
          <div><strong>Capacit√© :</strong> {{ heb.nb_personnes or 'N/A' }} pers.</div>
          <div><strong>Compteur eau :</strong>
            {{ heb.compteur_eau.replace('_', ' ').title() if heb.compteur_eau else 'N/A' }}
          </div>
        </div>

        <div class="small mb-3">
          <div class="text-muted">
            <i class="bi bi-clipboard-check"></i>
            Checks : <strong>{{ check_count }}</strong>
            ‚Ä¢
            <i class="bi bi-exclamation-triangle"></i>
            Incidents : <strong>{{ incident_count }}</strong>
          </div>
          <div class="text-muted">
            <i class="bi bi-clock"></i>
            Dernier check :
            {% if last_check_at %}
              <strong>{{ last_check_at.strftime('%d/%m/%Y %H:%M') }}</strong>
            {% else %}
              <span class="text-muted">Jamais</span>
            {% endif %}
          </div>
        </div>

        <div class="mt-auto d-grid gap-2">
  <a href="{{ url_for('check', hebergement_id=heb.id) }}" class="btn btn-primary btn-sm">
    <i class="bi bi-clipboard-check"></i> Faire un check
  </a>
  
  {# BOUTON VOIR LES PROBL√àMES - s'affiche uniquement s'il y a des incidents ouverts #}
  {% set nb_problemes = heb.incidents|selectattr("statut", "equalto", "ouvert")|list|length %}
  {% if nb_problemes > 0 %}
    <a href="{{ url_for('voir_problemes', hebergement_id=heb.id) }}" 
       class="btn btn-danger btn-sm">
      üö® Voir {{ nb_problemes }} probl√®me{% if nb_problemes > 1 %}s{% endif %}
    </a>
  {% endif %}
  
  {# BOUTON SIGNALER - toujours visible #}
  <a href="{{ url_for('signaler_incident', hebergement_id=heb.id) }}" 
     class="btn btn-outline-danger btn-sm">
    <i class="bi bi-exclamation-triangle-fill"></i> Signaler un probl√®me
  </a>
</div>

        {% if current_user.role == 'admin' %}
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal{{ heb.id }}">
            <i class="bi bi-pencil"></i>
          </button>

          {% if check_count == 0 and incident_count == 0 %}
          <a href="{{ url_for('delete_hebergement', id=heb.id) }}"
             class="btn btn-danger btn-sm"
             onclick="return confirm('Supprimer cet h√©bergement ?')">
            <i class="bi bi-trash"></i>
          </a>
          {% else %}
          <button class="btn btn-danger btn-sm" disabled title="Des checks ou incidents sont li√©s">
            <i class="bi bi-trash"></i>
          </button>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- Pagination (conserve les filtres) -->
{% if hebergements.pages > 1 %}
<nav aria-label="Navigation pages h√©bergements" class="mt-5">
  <ul class="pagination justify-content-center">

    {% if hebergements.has_prev %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('hebergements',
        page=hebergements.prev_num, q=q, statut=statut, type_id=type_id) }}">
        <i class="bi bi-chevron-left"></i> Pr√©c√©dente
      </a>
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link"><i class="bi bi-chevron-left"></i> Pr√©c√©dente</span>
    </li>
    {% endif %}

    {% for page_num in hebergements.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if page_num %}
        {% if hebergements.page == page_num %}
        <li class="page-item active" aria-current="page">
          <span class="page-link">{{ page_num }}</span>
        </li>
        {% else %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('hebergements',
            page=page_num, q=q, statut=statut, type_id=type_id) }}">{{ page_num }}</a>
        </li>
        {% endif %}
      {% else %}
      <li class="page-item disabled"><span class="page-link">...</span></li>
      {% endif %}
    {% endfor %}

    {% if hebergements.has_next %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('hebergements',
        page=hebergements.next_num, q=q, statut=statut, type_id=type_id) }}">
        Suivante <i class="bi bi-chevron-right"></i>
      </a>
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link">Suivante <i class="bi bi-chevron-right"></i></span>
    </li>
    {% endif %}
  </ul>

  <p class="text-center text-muted mt-2">
    Page {{ hebergements.page }} sur {{ hebergements.pages }} | {{ hebergements.total }} h√©bergements
  </p>
</nav>
{% endif %}

<!-- Auto-submit l√©ger (optionnel) : tape -> filtre apr√®s 400ms + select change -->
<script>
(function () {
  const form = document.querySelector('form[action="{{ url_for("hebergements") }}"]');
  if (!form) return;

  let t = null;
  const qInput = document.getElementById('qInput');
  const statutSelect = document.getElementById('statutSelect');
  const typeSelect = document.getElementById('typeSelect');

  if (qInput) {
    qInput.addEventListener('input', function () {
      clearTimeout(t);
      t = setTimeout(() => form.submit(), 400);
    });
  }
  if (statutSelect) statutSelect.addEventListener('change', () => form.submit());
  if (typeSelect) typeSelect.addEventListener('change', () => form.submit());
})();
</script>

<!-- ===================== MODALS ADMIN (complets) ===================== -->
{% if current_user.role == 'admin' %}

<!-- Modal Ajout -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('add_hebergement') }}">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Ajouter un h√©bergement</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Emplacement</label>
              <input class="form-control" name="emplacement" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Type</label>
              <select class="form-select" name="type_id" required>
                {% for t in types %}
                <option value="{{ t.id }}">{{ t }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">N¬∞ Ch√¢ssis</label>
              <input class="form-control" name="numero_chassis">
            </div>
            <div class="col-md-3">
              <label class="form-label">Capacit√©</label>
              <input class="form-control" name="nb_personnes" type="number" min="0">
            </div>
            <div class="col-md-3">
              <label class="form-label">Compteur eau</label>
              <input class="form-control" name="compteur_eau" placeholder="devant_droite">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-primary" type="submit">Ajouter</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modals Edition (1 par h√©bergement) -->
{% for heb, check_count, last_check_at, incident_count in hebergements.items %}
<div class="modal fade" id="editModal{{ heb.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('edit_hebergement', id=heb.id) }}">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil"></i> Modifier {{ heb.emplacement }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Emplacement</label>
              <input class="form-control" name="emplacement" value="{{ heb.emplacement }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Type</label>
              <select class="form-select" name="type_id" required>
                {% for t in types %}
                <option value="{{ t.id }}" {{ 'selected' if heb.type_id == t.id else '' }}>{{ t.nom }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">N¬∞ Ch√¢ssis</label>
              <input class="form-control" name="numero_chassis" value="{{ heb.numero_chassis or '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Capacit√©</label>
              <input class="form-control" name="nb_personnes" type="number" min="0" value="{{ heb.nb_personnes or '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Compteur eau</label>
              <input class="form-control" name="compteur_eau" value="{{ heb.compteur_eau or '' }}">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-primary" type="submit">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

{% endif %}
{% endblock %}
